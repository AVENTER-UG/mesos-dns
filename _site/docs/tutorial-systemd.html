<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Mesos-DNS: Mesos-DNS using systemd</title>
    <link rel="icon" type="image/x-icon" href="/mesos-dns/img/mesos-dns-favicon.ico">
    <link href="//cdn.jsdelivr.net/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="/mesos-dns/css/style.css" rel="stylesheet">
  </head>
  <body>
    <div class="container">
      <div class="row">
        <div class="col-sm-10 col-sm-offset-1">
          <div class="navbar navbar-default navbar-inverse" role="navigation">
            <div class="container-fluid">
              <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar-collapse">
                  <span class="sr-only">Toggle navigation</span>
                  <span class="icon-bar"></span>
                  <span class="icon-bar"></span>
                  <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="/mesos-dns/">Mesos-DNS</a>
              </div>
              <div class="collapse navbar-collapse" id="navbar-collapse">
                <ul class="nav navbar-nav">
                  <li class="active">
                    <a href="/mesos-dns/docs/">Docs</a>
                  </li>
                  <li >
                    <a href="/mesos-dns/resources.html">Resources</a>
                  </li>
                  <li >
                    <a href="/mesos-dns/support.html">Support</a>
                  </li>
                </ul>
                <ul class="nav navbar-nav navbar-right">
                  <li><a href="https://github.com/AVENTER-UG/mesos-dns">GitHub</a></li>
                </ul>
              </div>
            </div>
          </div>
          <div class="row">
  <div class="col-sm-3">
    <h5>Documentation</h5>
    <ul class="list-unstyled">
      <li>
        <a href="/mesos-dns/docs/">
          Installing and running
        </a>
      </li>
       <li>
        <a href="/mesos-dns/docs/configuration-parameters.html">
        Configuration</a>
      </li>
       <li>
        <a href="/mesos-dns/docs/naming.html">
          Service Naming
        </a>
      </li>
       <li>
        <a href="/mesos-dns/docs/http.html">
          HTTP API
        </a>
      </li>
      <li>
        <a href="/mesos-dns/docs/performance-tuning.html">
          Performance Tuning
        </a>
      </li>
       <li>
        <a href="/mesos-dns/docs/faq.html">
          FAQ & Troubleshooting
        </a>
      </li>
    <hr>
    <h5>Tutorials</h5>
    <ul class="list-unstyled">
       <li>
        <a href="/mesos-dns/docs/tutorial.html">
        Mesos-DNS</a>
      </li>
       <li>
        <a href="/mesos-dns/docs/tutorial-forward.html">
        Mesos-DNS and Bind</a>
      </li>
       <li>
        <a href="/mesos-dns/docs/tutorial-systemd.html">
        Mesos-DNS using Systemd</a>
      </li>

    <hr>
    </ul>
<!---
    <h5>Resources</h5>
    <ul class="list-unstyled">
      <li>
        <a href="/mesos-dns/docs/deployment-design-doc.html">
          Deployment Design
        </a>
      </li>
    </ul>
    <hr>
    <h5>Upgrading</h5>
    <ul class="list-unstyled">
      <li>
        <a href="/mesos-dns/docs/upgrade/06xto070.html">
          0.6.x to 0.7.0
        </a>
      </li>
    </ul>
-->
  </div>
  <div class="col-sm-9">
    <h1 id="mesos-dns-using-systemd">Mesos-DNS using systemd</h1>

<p>This is a step-by-step tutorial for running <a href="https://github.com/AVENTER-UG/mesos-dns">Mesos-DNS</a> with <a href="http://freedesktop.org/wiki/Software/systemd/">systemd</a>.</p>

<h2 id="step-1-launch-a-mesosphere-cluster-on-a-systemd-platform">Step 1: Launch a Mesosphere cluster on a systemd platform</h2>

<p>The first step is to create a Mesosphere cluster on a platform that supports systemd.   While all linux distros are moving in the direction of supporting systemd, the currently released list can be boiled down to RHEL 7, Suse v12 and CoreOS. Mesosphere’s DCOS is installed on CoreOS, however in this case Mesos-DNS is pre-installed. This tutorial assumes that you are installing a fresh Mesosphere cluster without using Mesos-DNS.  For help installing please refer to <a href="https://docs.mesosphere.com/getting-started/datacenter/install/">https://docs.mesosphere.com/getting-started/datacenter/install/</a>.</p>

<p>This tutorial assumes the following cluster topology:</p>

<ul>
  <li>One master node which includes:
    <ul>
      <li>Mesos master</li>
      <li>ZooKeeper</li>
      <li>Marathon</li>
      <li>IP</li>
    </ul>
  </li>
  <li>Several slave nodes which have Mesos agent running on them.</li>
</ul>

<p>For this tutorial we will assume the master IP address is <code class="language-plaintext highlighter-rouge">10.14.245.208</code>.</p>

<h2 id="step-2-install-mesos-dns">Step 2: Install Mesos-DNS</h2>

<p>We will install Mesos-DNS on node <code class="language-plaintext highlighter-rouge">10.14.245.208</code>. Access the node through ssh.</p>

<p>After downloading a <a href="https://github.com/AVENTER-UG/mesos-dns/releases">release</a> and extracting it, place the executable in well known location such as <code class="language-plaintext highlighter-rouge">/usr/bin/mesos-dns</code>.</p>

<p>In the <code class="language-plaintext highlighter-rouge">/etc/mesos-dns/</code> directory let’s create a file named <code class="language-plaintext highlighter-rouge">config.json</code> with the following contents:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"zk"</span><span class="p">:</span><span class="w"> </span><span class="s2">"zk://10.14.245.208:2181/mesos"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"refreshSeconds"</span><span class="p">:</span><span class="w"> </span><span class="mi">60</span><span class="p">,</span><span class="w">
  </span><span class="nl">"ttl"</span><span class="p">:</span><span class="w"> </span><span class="mi">60</span><span class="p">,</span><span class="w">
  </span><span class="nl">"domain"</span><span class="p">:</span><span class="w"> </span><span class="s2">"mesos"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"port"</span><span class="p">:</span><span class="w"> </span><span class="mi">53</span><span class="p">,</span><span class="w">
  </span><span class="nl">"resolvers"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"169.254.169.254"</span><span class="p">,</span><span class="s2">"10.0.0.1"</span><span class="p">],</span><span class="w">
  </span><span class="nl">"timeout"</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w">
  </span><span class="nl">"email"</span><span class="p">:</span><span class="w"> </span><span class="s2">"root.mesos-dns.mesos"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">resolvers</code> field includes the two nameservers listed in the <code class="language-plaintext highlighter-rouge">/etc/resolv.conf</code> of the nodes in this cluster.</p>

<h2 id="step-3-running-under-systemd">Step 3: Running under systemd</h2>

<p>In the <code class="language-plaintext highlighter-rouge">/etc/systemd/system</code> directory lets create a file named <code class="language-plaintext highlighter-rouge">mesos-dns.service</code> with the following contents:</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[Unit]
Description=Mesos-DNS
After=network.target
Wants=network.target

[Service]
ExecStart=/usr/bin/mesos-dns -config=/etc/mesos-dns/config.json
Restart=on-failure
RestartSec=20

[Install]
WantedBy=multi-user.target
</code></pre></div></div>

<p>Now start the service:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>systemctl start mesos-dns
</code></pre></div></div>

<h2 id="step-4-configure-cluster-nodes">Step 4: Configure cluster nodes</h2>

<p>Next, we will configure all the nodes in our cluster to use Mesos-DNS as their DNS server. Access each node through SSH and execute:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo sed</span> <span class="nt">-i</span> <span class="s1">'1s/^/nameserver 10.14.245.208\n /'</span> /etc/resolv.conf
</code></pre></div></div>

<p>We can verify that the configuration is correct and that Mesos-DNS can serve DNS queries using the following commands:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span><span class="nb">cat</span> /etc/resolv.conf
<span class="go">nameserver 10.14.245.208
domain c.myproject.internal.
search c.myprojecct.internal. 267449633760.google.internal. google.internal.
nameserver 169.254.169.254
nameserver 10.0.0.1

</span><span class="gp">$</span><span class="w"> </span>host www.google.com
<span class="go">www.google.com has address 74.125.70.104
www.google.com has address 74.125.70.147
www.google.com has address 74.125.70.99
www.google.com has address 74.125.70.105
www.google.com has address 74.125.70.106
www.google.com has address 74.125.70.103
www.google.com has IPv6 address 2607:f8b0:4001:c02::93
</span></code></pre></div></div>

<p>To be 100% sure that Mesos-DNS is actually the server that provided the translation above, we can try:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>dig www.google.com

<span class="p">;</span> &lt;&lt;<span class="o">&gt;&gt;</span> DiG 9.8.4-rpz2+rl005.12-P1 &lt;&lt;<span class="o">&gt;&gt;</span> www.google.com
<span class="p">;;</span> global options: +cmd
<span class="p">;;</span> Got answer:
<span class="p">;;</span> -&gt;&gt;HEADER<span class="o">&lt;&lt;-</span> <span class="no">opcode</span><span class="sh">: QUERY, status: NOERROR, id: 45045
;; flags: qr rd ra; QUERY: 1, ANSWER: 6, AUTHORITY: 0, ADDITIONAL: 0

;; QUESTION SECTION:
;www.google.com.      IN  A

;; ANSWER SECTION:
www.google.com.   228 IN  A 74.125.201.105
www.google.com.   228 IN  A 74.125.201.103
www.google.com.   228 IN  A 74.125.201.147
www.google.com.   228 IN  A 74.125.201.104
www.google.com.   228 IN  A 74.125.201.106
www.google.com.   228 IN  A 74.125.201.99

;; Query time: 3 msec
;; SERVER: 10.14.245.208#53(10.14.245.208)
;; WHEN: Sat Jan 24 01:03:38 2015
;; MSG SIZE  rcvd: 212
</span></code></pre></div></div>

<p>The line marked <code class="language-plaintext highlighter-rouge">SERVER</code> makes it clear that the process we launched to listen on port <code class="language-plaintext highlighter-rouge">53</code> on node <code class="language-plaintext highlighter-rouge">10.14.245.208</code> is providing the answer. This is Mesos-DNS.</p>

<h2 id="step-5-launch-nginx-using-mesos">Step 5: Launch nginx using Mesos</h2>

<p>Now let’s launch a task using Mesos. We will strat the nginx webserver using Marathon and Docker. We will use the master node for this:</p>

<p>First, create a configuration file for nginx named <code class="language-plaintext highlighter-rouge">nginx.json</code> with the following content:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"nginx"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"container"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"DOCKER"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"docker"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"image"</span><span class="p">:</span><span class="w"> </span><span class="s2">"nginx:1.7.7"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"network"</span><span class="p">:</span><span class="w"> </span><span class="s2">"HOST"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"instances"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
  </span><span class="nl">"cpus"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
  </span><span class="nl">"mem"</span><span class="p">:</span><span class="w"> </span><span class="mi">640</span><span class="p">,</span><span class="w">
  </span><span class="nl">"constraints"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">[</span><span class="w">
      </span><span class="s2">"hostname"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"UNIQUE"</span><span class="w">
    </span><span class="p">]</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>You can launch it on Mesos using:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-X</span> POST <span class="nt">-H</span> <span class="s2">"Content-Type: application/json"</span> http://10.41.40.151:8080/v2/apps <span class="nt">-d</span>@nginx.json
</code></pre></div></div>

<p>This will launch nginx on one of the three agents using Docker and host networking. You can use the Marathon web UI to verify it is running without problems. It turns out that Mesos launched it on node <code class="language-plaintext highlighter-rouge">10.114.227.92</code> and we can verify it works using:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>curl http://10.114.227.92
<span class="gp">&lt;!DOCTYPE html&gt;</span><span class="w">
</span><span class="gp">&lt;html&gt;</span><span class="w">
</span><span class="gp">&lt;head&gt;</span><span class="w">
</span><span class="gp">&lt;title&gt;</span>Welcome to nginx!&lt;/title&gt;
<span class="gp">&lt;style&gt;</span><span class="w">
</span><span class="go">    body {
</span><span class="gp">        width: 35em;</span><span class="w">
</span><span class="gp">        margin: 0 auto;</span><span class="w">
</span><span class="gp">        font-family: Tahoma, Verdana, Arial, sans-serif;</span><span class="w">
</span><span class="go">    }
</span><span class="gp">&lt;/style&gt;</span><span class="w">
</span><span class="gp">&lt;/head&gt;</span><span class="w">
</span><span class="gp">&lt;body&gt;</span><span class="w">
</span><span class="gp">&lt;h1&gt;</span>Welcome to nginx!&lt;/h1&gt;
<span class="gp">&lt;p&gt;</span>If you see this page, the nginx web server is successfully installed and
<span class="gp">working. Further configuration is required.&lt;/p&gt;</span><span class="w">
</span><span class="go">
</span><span class="gp">&lt;p&gt;</span>For online documentation and support please refer to
<span class="gp">&lt;a href="http://nginx.org/"&gt;</span>nginx.org&lt;/a&gt;.&lt;br/&gt;
<span class="go">Commercial support is available at
</span><span class="gp">&lt;a href="http://nginx.com/"&gt;</span>nginx.com&lt;/a&gt;.&lt;/p&gt;
<span class="go">
</span><span class="gp">&lt;p&gt;</span>&lt;em&gt;Thank you <span class="k">for </span>using nginx.&lt;/em&gt;&lt;/p&gt;
<span class="gp">&lt;/body&gt;</span><span class="w">
</span><span class="gp">&lt;/html&gt;</span><span class="w">
</span></code></pre></div></div>

<h2 id="step-6-use-mesos-dns-to-connect-to-nginx">Step 6: Use Mesos-DNS to connect to nginx</h2>

<p>Now, let’s use Mesos-DNS to communicate with nginx. We will still use the master node.</p>

<p>First, let’s do a DNS lookup for nginx, using the expected name <code class="language-plaintext highlighter-rouge">nginx.marathon-0.8.1.mesos</code>. The version number of Marathon is there because it registed with Mesos using name <code class="language-plaintext highlighter-rouge">marathon-0.8.1</code>. We could have avoided this by launching Marathon using <code class="language-plaintext highlighter-rouge">--framework_name marathon</code>:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>dig nginx.marathon-0.8.1.mesos
<span class="go">
</span><span class="gp">;</span><span class="w"> </span>&lt;&lt;<span class="o">&gt;&gt;</span> DiG 9.8.4-rpz2+rl005.12-P1 &lt;&lt;<span class="o">&gt;&gt;</span> nginx.marathon-0.8.1.mesos
<span class="gp">;</span><span class="p">;</span> global options: +cmd
<span class="gp">;</span><span class="p">;</span> Got answer:
<span class="gp">;</span><span class="p">;</span> -&gt;&gt;HEADER<span class="o">&lt;&lt;-</span> <span class="no">opcode</span><span class="sh">: QUERY, status: NOERROR, id: 11742
</span><span class="gp">;</span><span class="sh">; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 0
</span><span class="go">
</span><span class="gp">;</span><span class="p">;</span> QUESTION SECTION:
<span class="gp">;</span>nginx.marathon-0.8.1.mesos. IN A
<span class="go">
</span><span class="gp">;</span><span class="p">;</span> ANSWER SECTION:
<span class="go">nginx.marathon-0.8.1.mesos. 60 IN A 10.114.227.92

</span><span class="gp">;</span><span class="p">;</span> Query <span class="nb">time</span>: 0 msec
<span class="gp">;</span><span class="p">;</span> SERVER: 10.14.245.208#53<span class="o">(</span>10.14.245.208<span class="o">)</span>
<span class="gp">;</span><span class="p">;</span> WHEN: Sat Jan 24 01:11:46 2015
<span class="gp">;</span><span class="p">;</span> MSG SIZE  rcvd: 96
<span class="go">
</span></code></pre></div></div>

<p>Mesos-DNS informed us that nginx is running on node <code class="language-plaintext highlighter-rouge">10.114.227.92</code>. Now let’s try to connect to it using its domain name:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>curl http://nginx.marathon-0.8.1.mesos
<span class="gp">&lt;!DOCTYPE html&gt;</span><span class="w">
</span><span class="gp">&lt;html&gt;</span><span class="w">
</span><span class="gp">&lt;head&gt;</span><span class="w">
</span><span class="gp">&lt;title&gt;</span>Welcome to nginx!&lt;/title&gt;
<span class="gp">&lt;style&gt;</span><span class="w">
</span><span class="go">    body {
</span><span class="gp">        width: 35em;</span><span class="w">
</span><span class="gp">        margin: 0 auto;</span><span class="w">
</span><span class="gp">        font-family: Tahoma, Verdana, Arial, sans-serif;</span><span class="w">
</span><span class="go">    }
</span><span class="gp">&lt;/style&gt;</span><span class="w">
</span><span class="gp">&lt;/head&gt;</span><span class="w">
</span><span class="gp">&lt;body&gt;</span><span class="w">
</span><span class="gp">&lt;h1&gt;</span>Welcome to nginx!&lt;/h1&gt;
<span class="gp">&lt;p&gt;</span>If you see this page, the nginx web server is successfully installed and
<span class="gp">working. Further configuration is required.&lt;/p&gt;</span><span class="w">
</span><span class="go">
</span><span class="gp">&lt;p&gt;</span>For online documentation and support please refer to
<span class="gp">&lt;a href="http://nginx.org/"&gt;</span>nginx.org&lt;/a&gt;.&lt;br/&gt;
<span class="go">Commercial support is available at
</span><span class="gp">&lt;a href="http://nginx.com/"&gt;</span>nginx.com&lt;/a&gt;.&lt;/p&gt;
<span class="go">
</span><span class="gp">&lt;p&gt;</span>&lt;em&gt;Thank you <span class="k">for </span>using nginx.&lt;/em&gt;&lt;/p&gt;
<span class="gp">&lt;/body&gt;</span><span class="w">
</span><span class="gp">&lt;/html&gt;</span><span class="w">
</span></code></pre></div></div>

<p>We have successfully connected to nginx using a domain name. Mesos-DNS works!</p>

<h2 id="step-7-scaling-out-nginx">Step 7: Scaling out nginx</h2>

<p>Use the Marathon web UI to scale nginx to two instances. Alternatively, relaunch it after editing the JSON file in step 5 to indicate 2 instances. A minute later, we can look it up again using Mesos-DNS and get:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w">  </span>dig nginx.marathon-0.8.1.mesos
<span class="go">
</span><span class="gp">;</span><span class="w"> </span>&lt;&lt;<span class="o">&gt;&gt;</span> DiG 9.8.4-rpz2+rl005.12-P1 &lt;&lt;<span class="o">&gt;&gt;</span> nginx.marathon-0.8.1.mesos
<span class="gp">;</span><span class="p">;</span> global options: +cmd
<span class="gp">;</span><span class="p">;</span> Got answer:
<span class="gp">;</span><span class="p">;</span> -&gt;&gt;HEADER<span class="o">&lt;&lt;-</span> <span class="no">opcode</span><span class="sh">: QUERY, status: NOERROR, id: 30550
</span><span class="gp">;</span><span class="sh">; flags: qr aa rd ra; QUERY: 1, ANSWER: 2, AUTHORITY: 0, ADDITIONAL: 0
</span><span class="go">
</span><span class="gp">;</span><span class="p">;</span> QUESTION SECTION:
<span class="gp">;</span>nginx.marathon-0.8.1.mesos. IN A
<span class="go">
</span><span class="gp">;</span><span class="p">;</span> ANSWER SECTION:
<span class="go">nginx.marathon-0.8.1.mesos. 60 IN A 10.29.107.105
nginx.marathon-0.8.1.mesos. 60 IN A 10.114.227.92

</span><span class="gp">;</span><span class="p">;</span> Query <span class="nb">time</span>: 1 msec
<span class="gp">;</span><span class="p">;</span> SERVER: 10.14.245.208#53<span class="o">(</span>10.14.245.208<span class="o">)</span>
<span class="gp">;</span><span class="p">;</span> WHEN: Sat Jan 24 01:24:07 2015
<span class="gp">;</span><span class="p">;</span> MSG SIZE  rcvd: 143
</code></pre></div></div>

<p>Now, Mesos-DNS is giving us two A records for the same name, identifying both instances of nginx on our cluster.</p>

  </div>
</div>

          <footer>
            <p class="text-muted">
              &copy; 2015 <a class="text-muted" href="http://mesosphere.com">Mesosphere, Inc.</a>
              &copy; 2021 <a class="text-muted" href="https://www.aventer.biz">AVENTER UG (haftungsbeschränkt).</a>
            </p>
          </footer>
        </div>
      </div>
    </div>
    <script src="//cdn.jsdelivr.net/jquery/2.1.1/jquery.min.js"></script>
    <script src="//cdn.jsdelivr.net/bootstrap/3.2.0/js/bootstrap.min.js"></script>
  </body>
</html>
